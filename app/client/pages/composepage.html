<div class="mainarea-header">
    <div class="sidebar-wsinfoarea-stack-nohover">
        <div id="mainarea-header-title">
            Compose Message
        </div>

        <div id="mainarea-header-sub">
            
        </div>
    </div>
</div>
<script>
    document.title = "Compose Message | Clatter"
    setTimeout(async () => {
        var inputbox = document.createElement("input")
        inputbox.id = "compose-recipient-input"
        inputbox.placeholder = "Message"
        inputbox.type = "text"
        inputbox.setAttribute("autocomplete", "off")
        document.getElementById("mainarea-header-sub").appendChild(inputbox)
        var members = (await authClient.organization.getFullOrganization()).data.members
        members = members.map(member => {
            return member.user
        })
        members = members.filter(member => {
            return member.email != authsession.data.user.email
        })
        var channels = (await (await fetch("/api/channels/list")).json()).filter(channel => {
            return channel.type.split(".")[1] == "channeltype"
        })
        var fulllist = channels.concat(members)
        const autoCompleteJS = new autoComplete({
            placeHolder: "Type to search...",
            data: {
                src: fulllist,
                keys: ["name"]
            },
            selector: "#compose-recipient-input",
            resultsList: {
                tabSelect: true,
            },
            resultItem: {
                element: (item, data) => {
                    item.style.display = "flex"
                    item.style.flexdirection = "row"
                    item.style.alignItems = "center"
                    if (data.value.email != undefined) {
                        var icon = document.createElement("i")
                        icon.style.marginRight = "10px"
                        icon.classList.add("icon-user")
                        item.prepend(icon)
                    } else {
                        var icon = document.createElement("i")
                        icon.style.marginRight = "10px"
                        icon.classList.add("icon-hash")
                        item.prepend(icon)
                    }
                }
            }
        })
        autoCompleteJS.start()
        inputbox.addEventListener("selection", async (event) => {
            console.log(event.detail.selection.value)
            if(event.detail.selection.value.type?.split(".")[1] == "channeltype") {
                currentchannelid = event.detail.selection.value.id
                NavigatePage("channelpage")
                setTimeout(() => {
                    document.getElementById("messagebox").focus()
                }, 500)
            } else if (event.detail.selection.value.email != undefined) {
                var chats = (await (await fetch("/api/channels/list")).json()).filter(channel => {
                    return channel.type.split(".")[1] == "directtype"
                })
                var foundchat = false
                chats.forEach(element => {
                    if (element.members.includes(event.detail.selection.value.id) && element.members.includes(authsession.data.user.id) && element.members.length == 2) {
                        foundchat = true
                        currentchannelid = element.id
                        NavigatePage("directpage")
                        setTimeout(() => {
                            document.getElementById("messagebox").focus()
                        }, 500)
                    }
                });
                if (foundchat == false) {
                    var req = await fetch("/api/direct/create1x1?recipientid=" + event.detail.selection.value.id, {
                        method: "POST",
                    })
                    var res = await req.json()
                    console.log(res)
                    foundchat = true
                    currentchannelid = res.id
                    NavigatePage("directpage")
                    setTimeout(() => {
                        document.getElementById("messagebox").focus()
                    }, 500)
                }
            }
        })
        inputbox.focus()
    }, 50)
</script>